<!-- MonthlyChart.svelte -->
<script lang="ts">
	import {
		ChartContainer,
		type ChartConfig,
		Card,
		CardHeader,
		CardTitle,
		CardContent
	} from '$lib/shadcn/components'; // Type Definitions	interface DailyMetric {		date: string;		total_sales: number;		amazon_sales: number;		ebay_sales: number;		shopify_sales: number;		linnworks_total_orders: number;		labor_efficiency?: number;	}	interface Props {		data: DailyMetric[];		class?: string;	}	let { data = [], class: className = '' }: Props = $props();	// Configuration	const chartConfig = {		amazon: {			label: 'Amazon',			color: '#2563eb'		},		ebay: {			label: 'eBay', 			color: '#dc2626'		},		shopify: {			label: 'Shopify',			color: '#059669'		}	} satisfies ChartConfig;	// Utility Functions	function formatCurrency(value: number): string {		return new Intl.NumberFormat('en-GB', {			style: 'currency',			currency: 'GBP',			maximumFractionDigits: 0		}).format(value);	}	function formatPercentage(part: number, total: number): string {		if (total === 0) return '0.0';		return ((part / total) * 100).toFixed(1);	}	// Chart Data Processing	const chartData = $derived(		data.map((item) => ({			date: new Date(item.date).toLocaleDateString('en-GB', {				day: '2-digit',				month: 'short'			}),			amazon: item.amazon_sales,			ebay: item.ebay_sales,			shopify: item.shopify_sales,			total: item.total_sales		}))	);	const channelTotals = $derived([		{			key: 'amazon',			label: 'Amazon',			color: '#2563eb',			total: data.reduce((sum, item) => sum + item.amazon_sales, 0)		},		{			key: 'ebay',			label: 'eBay',			color: '#dc2626',			total: data.reduce((sum, item) => sum + item.ebay_sales, 0)		},		{			key: 'shopify',			label: 'Shopify',			color: '#059669',			total: data.reduce((sum, item) => sum + item.shopify_sales, 0)		}	]);	const grandTotal = $derived(channelTotals.reduce((sum, channel) => sum + channel.total, 0));	// Chart Layout Calculations	const channels = [		{ key: 'amazon', label: 'Amazon', color: '#2563eb' },		{ key: 'ebay', label: 'eBay', color: '#dc2626' },		{ key: 'shopify', label: 'Shopify', color: '#059669' }	];	const maxValue = $derived(		Math.max(			...chartData.flatMap((d) => channels.map((ch) => d[ch.key as keyof typeof d] as number))		)	);	const chartArea = {		width: 940,		height: 300	};	const barWidth = $derived(chartData.length > 0 ? chartArea.width / chartData.length : 0);	const individualBarWidth = $derived(Math.max(8, (barWidth * 0.8) / channels.length));	// Generate Y-axis tick values	const yAxisTicks = $derived(() => {		if (maxValue === 0) return [0];		const step = Math.ceil(maxValue / 5 / 1000) * 1000;		return Array.from({ length: 6 }, (_, i) => i * step);	});	// Interactive State Management	let hoveredBar: number | null = $state(null);	let hoveredChannel: string | null = $state(null);	let mousePosition = $state({ x: 0, y: 0 });	// Chart Positioning Functions	function getBarX(dayIndex: number, channelIndex: number): number {		const dayStartX = 50 + dayIndex * barWidth;		const groupStartX = dayStartX + (barWidth * 0.1) / 2;		return groupStartX + channelIndex * individualBarWidth;	}	function getBarHeight(value: number): number {		return maxValue > 0 ? (value / maxValue) * chartArea.height : 0;	}	function getBarY(value: number): number {		const height = getBarHeight(value);		return 40 + chartArea.height - height;	}	function getTickY(tickValue: number): number {		return 40 + chartArea.height - (tickValue / maxValue) * chartArea.height;	}	function formatCompactCurrency(value: number): string {		if (value >= 1000000) {			return `£${(value / 1000000).toFixed(1)}M`;		}		if (value >= 1000) {			return `£${(value / 1000).toFixed(0)}k`;		}		return `£${value.toFixed(0)}`;	}	// Event Handlers	function handleBarMouseMove(event: MouseEvent, barIndex: number, channelKey: string) {		hoveredBar = barIndex;		hoveredChannel = channelKey;		mousePosition = { x: event.clientX, y: event.clientY };	}	function handleMouseLeave() {		hoveredBar = null;		hoveredChannel = null;	}
</script>
